<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ShingWhaçš„ç¬”è®°</title>
        <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
        <style>
            /* è¿™é‡Œä¿ç•™ä½ åŸæ¥çš„ CSS æ ·å¼ä¸å˜ */
            /* ... (ä¿æŒä½ æä¾›çš„ CSS) ... */
            :root {
                --bg-primary: #0a0a0a;
                --bg-secondary: #141414;
                --bg-tertiary: #1a1a1a;
                --border-color: #27272a;
                --text-primary: #fafafa;
                --text-secondary: #a1a1aa;
                --text-tertiary: #71717a;
                --accent-color: #3b82f6;
                --hover-bg: #1f1f22;
                --active-bg: #27272a;
                --active-border: #3b82f6;
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                overflow-y: auto;
                height: auto;
                margin: 0;
            }
            .container {
                display: flex;
                min-height: 100vh;
            }
            .sidebar {
                width: 280px;
                background: var(--bg-secondary);
                border-right: 1px solid var(--border-color);
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 100;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .sidebar-header {
                padding: 20px 16px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .logo {
                font-size: 14px;
                font-weight: 700;
                text-transform: uppercase;
                color: var(--text-primary);
            }
            .header-actions {
                display: flex;
                gap: 8px;
            }
            .icon-btn {
                width: 28px;
                height: 28px;
                border: 1px solid var(--border-color);
                background: transparent;
                color: var(--text-secondary);
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }
            .icon-btn:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
            }
            .nav-tree {
                flex: 1;
                overflow-y: auto;
                padding: 8px 0;
                height: calc(100vh - 60px);
            }
            .nav-item-content {
                display: flex;
                align-items: center;
                padding: 6px 16px;
                cursor: pointer;
                border-left: 2px solid transparent;
                transition: background 0.15s;
            }
            .nav-item-content:hover {
                background: var(--hover-bg);
            }
            .nav-item-content.active {
                background: var(--active-bg);
                border-left-color: var(--active-border);
            }
            .nav-text {
                flex: 1;
                font-size: 13px;
                color: var(--text-secondary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .nav-toggle {
                width: 16px;
                font-size: 10px;
                color: var(--text-tertiary);
                transition: transform 0.2s;
            }
            .nav-toggle.expanded {
                transform: rotate(90deg);
            }
            .nav-children {
                margin-left: 12px;
                border-left: 1px solid var(--border-color);
                overflow: hidden;
                display: none;
            }
            .nav-children.show {
                display: block;
            }
            .nav-loading {
                color: var(--text-tertiary);
                font-size: 12px;
                padding: 4px 16px;
                font-style: italic;
            }
            .nav-item-content.loading {
                opacity: 0.6;
                cursor: wait;
            }
            .main-content {
                flex: 1;
                margin-left: 280px;
                display: flex;
                flex-direction: column;
            }
            .toolbar {
                height: 56px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                background: var(--bg-secondary);
                position: sticky;
                top: 0;
                z-index: 50;
            }
            .content-area {
                padding: 32px 48px;
                max-width: 900px;
                margin: 0 auto;
                width: 100%;
            }
            .markdown-body {
                line-height: 1.8;
                color: var(--text-primary);
                font-size: 15px;
                word-wrap: break-word;
            }
            .markdown-body h1,
            .markdown-body h2,
            .markdown-body h3,
            .markdown-body h4 {
                margin-top: 24px;
                margin-bottom: 12px;
                line-height: 1.3;
                font-weight: 600;
            }
            .markdown-body h1 {
                font-size: 28px;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 8px;
            }
            .markdown-body h2 {
                font-size: 22px;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 6px;
            }
            .markdown-body h3 {
                font-size: 18px;
            }
            .markdown-body p {
                margin-bottom: 16px;
            }
            .markdown-body ul,
            .markdown-body ol {
                margin-bottom: 16px;
                padding-left: 24px;
            }
            .markdown-body li {
                margin-bottom: 6px;
            }
            .markdown-body code {
                background: var(--bg-tertiary);
                padding: 2px 6px;
                border-radius: 3px;
                font-family: "Consolas", "Monaco", monospace;
                font-size: 14px;
            }
            .markdown-body pre {
                background: var(--bg-tertiary);
                padding: 16px;
                border-radius: 6px;
                overflow-x: auto;
                margin-bottom: 16px;
                border: 1px solid var(--border-color);
            }
            .markdown-body pre code {
                background: none;
                padding: 0;
            }
            .markdown-body blockquote {
                border-left: 3px solid var(--accent-color);
                padding-left: 16px;
                margin: 16px 0;
                color: var(--text-secondary);
                background: rgba(59, 130, 246, 0.05);
                padding: 12px 16px;
                border-radius: 4px;
            }
            .markdown-body a {
                color: var(--accent-color);
                text-decoration: none;
            }
            .markdown-body a:hover {
                text-decoration: underline;
            }
            .markdown-body table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 16px;
            }
            .markdown-body th,
            .markdown-body td {
                border: 1px solid var(--border-color);
                padding: 8px 12px;
                text-align: left;
            }
            .markdown-body th {
                background: var(--bg-tertiary);
                font-weight: 600;
            }
            .markdown-body img {
                max-width: 100%;
                height: auto;
                border-radius: 6px;
            }
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            .modal-overlay.active {
                display: flex;
            }
            .modal {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                width: 90%;
                max-width: 500px;
                padding: 24px;
            }
            .form-group {
                margin-bottom: 16px;
            }
            .form-input {
                width: 100%;
                padding: 8px 12px;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                color: #fff;
                border-radius: 4px;
            }
            .btn {
                padding: 6px 12px;
                border: 1px solid var(--border-color);
                background: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                border-radius: 4px;
            }
            .btn.primary {
                background: var(--accent-color);
                color: white;
                border: none;
            }
            .toast {
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 10px 20px;
                background: #333;
                color: #fff;
                border-radius: 4px;
                opacity: 0;
                transition: 0.3s;
                pointer-events: none;
            }
            .toast.show {
                opacity: 1;
            }

            /* ç§»åŠ¨ç«¯é€‚é…æ ·å¼ */
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 90;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .mobile-overlay.active {
                display: block;
                opacity: 1;
            }

            /* å¹³æ¿å’Œæ‰‹æœºé€‚é… (â‰¤ 1024px) */
            @media screen and (max-width: 1024px) {
                .sidebar {
                    transform: translateX(-100%);
                    transition: transform 0.3s ease-in-out;
                    width: 280px;
                }

                .sidebar.open {
                    transform: translateX(0);
                }

                .main-content {
                    margin-left: 0;
                }

                .mobile-menu-btn {
                    display: flex !important;
                }

                .content-area {
                    padding: 20px 16px;
                    max-width: 100%;
                }

                .toolbar {
                    padding: 0 12px;
                    height: 50px;
                }

                .toolbar-title {
                    font-size: 14px;
                }

                .btn {
                    padding: 4px 8px;
                    font-size: 13px;
                }

                .icon-btn {
                    width: 32px;
                    height: 32px;
                }

                /* ä¼˜åŒ– Markdown å†…å®¹æ˜¾ç¤º */
                .markdown-body {
                    font-size: 14px;
                    line-height: 1.7;
                }

                .markdown-body h1 {
                    font-size: 24px;
                }

                .markdown-body h2 {
                    font-size: 20px;
                }

                .markdown-body h3 {
                    font-size: 17px;
                }

                .markdown-body pre {
                    padding: 12px;
                    font-size: 13px;
                }

                .markdown-body code {
                    font-size: 13px;
                }

                .markdown-body table {
                    font-size: 13px;
                }

                .markdown-body th,
                .markdown-body td {
                    padding: 6px 8px;
                }

                .nav-item-content {
                    padding: 8px 16px;
                    min-height: 40px; /* å¢å¤§ç‚¹å‡»åŒºåŸŸ */
                }

                .nav-text {
                    font-size: 14px;
                }

                /* æ¨¡æ€æ¡†é€‚é… */
                .modal {
                    width: 95%;
                    padding: 20px;
                }

                .form-input {
                    padding: 10px 12px;
                    font-size: 14px;
                }

                .btn {
                    min-height: 36px; /* å¢å¤§è§¦æ‘¸åŒºåŸŸ */
                }

                /* Toast ä½ç½®è°ƒæ•´ */
                .toast {
                    bottom: 10px;
                    right: 10px;
                    left: 10px;
                    text-align: center;
                }
            }

            /* æ‰‹æœºä¸“ç”¨é€‚é… (â‰¤ 768px) */
            @media screen and (max-width: 768px) {
                .sidebar-header {
                    padding: 16px 12px;
                }

                .logo {
                    font-size: 13px;
                }

                .content-area {
                    padding: 16px 12px;
                }

                .toolbar {
                    padding: 0 8px;
                }

                .header-actions {
                    gap: 6px;
                }

                /* ä¼˜åŒ–å¯¼èˆªæ ‘æ˜¾ç¤º */
                .nav-children {
                    margin-left: 8px;
                }

                /* ç¡®ä¿æŒ‰é’®åœ¨ç§»åŠ¨ç«¯æ˜“äºç‚¹å‡» */
                .icon-btn,
                .btn {
                    min-width: 36px;
                }

                /* æ¨¡æ€æ¡†å…¨å±ä¼˜åŒ– */
                .modal {
                    width: 100%;
                    height: 100%;
                    max-width: none;
                    border-radius: 0;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                }

                .modal-actions {
                    display: flex;
                    gap: 8px;
                    margin-top: 16px;
                }

                .modal-actions .btn {
                    flex: 1;
                }
            }

            /* è¶…å°å±å¹•é€‚é… (â‰¤ 480px) */
            @media screen and (max-width: 480px) {
                .markdown-body h1 {
                    font-size: 22px;
                }

                .markdown-body h2 {
                    font-size: 18px;
                }

                .markdown-body h3 {
                    font-size: 16px;
                }

                .markdown-body {
                    font-size: 13px;
                }

                .toolbar-title {
                    font-size: 13px;
                    max-width: 150px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }

                .btn span {
                    display: none; /* éšè—æŒ‰é’®æ–‡å­—ï¼Œåªæ˜¾ç¤ºå›¾æ ‡ */
                }

                .btn {
                    padding: 4px 6px;
                }
            }

            /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
            @media (hover: none) and (pointer: coarse) {
                .nav-item-content:hover,
                .icon-btn:hover,
                .btn:hover {
                    background: inherit; /* ç§»é™¤ hover æ•ˆæœ */
                }

                .nav-item-content:active,
                .icon-btn:active,
                .btn:active {
                    opacity: 0.7; /* æ·»åŠ ç‚¹å‡»åé¦ˆ */
                }

                /* å¢å¤§æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´ çš„è§¦æ‘¸åŒºåŸŸ */
                .nav-item-content {
                    padding: 10px 16px;
                }

                .icon-btn {
                    margin: 2px; /* å¢åŠ å¤–éƒ¨é—´è· */
                }
            }

            /* é˜²æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾ */
            @media (max-width: 1024px) {
                button,
                .icon-btn,
                .btn,
                .nav-item-content {
                    touch-action: manipulation;
                }
            }

            /* ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡ºæ—¶çš„å¸ƒå±€ä¼˜åŒ– */
            @media (max-width: 768px) {
                /* é˜²æ­¢è¾“å…¥æ¡†è¢«é”®ç›˜é®æŒ¡ */
                .form-input:focus {
                    font-size: 16px; /* iOS é˜²æ­¢ç¼©æ”¾ */
                }

                /* ç¡®ä¿æ¨¡æ€æ¡†åœ¨é”®ç›˜å¼¹å‡ºæ—¶èƒ½æ»šåŠ¨ */
                .modal-overlay.active {
                    overflow: auto;
                    -webkit-overflow-scrolling: touch;
                }

                .modal {
                    max-height: 90vh;
                    overflow-y: auto;
                    -webkit-overflow-scrolling: touch;
                }
            }

            /* ä¼˜åŒ– iOS Safari çš„æ»šåŠ¨è¡Œä¸º */
            @supports (-webkit-touch-callout: none) {
                @media (max-width: 1024px) {
                    body {
                        -webkit-overflow-scrolling: touch;
                    }

                    .sidebar,
                    .main-content,
                    .modal {
                        -webkit-overflow-scrolling: touch;
                    }
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="logo">NOTES</div>
                    <div class="header-actions">
                        <button class="icon-btn" id="refreshBtn" title="åˆ·æ–°">
                            â†»
                        </button>
                        <button class="icon-btn" id="settingsBtn" title="é…ç½®">
                            âš™
                        </button>
                    </div>
                </div>
                <div class="nav-tree" id="navTree"></div>
            </aside>
            <div class="mobile-overlay" id="mobileOverlay"></div>
            <main class="main-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button
                            class="icon-btn mobile-menu-btn"
                            id="mobileMenuBtn"
                            style="display: none"
                        >
                            â˜°
                        </button>
                        <div class="toolbar-title" id="toolbarTitle">
                            æ¬¢è¿ä½¿ç”¨
                        </div>
                    </div>
                    <div class="toolbar-actions">
                        <button class="btn" id="githubBtn">
                            <span>ğŸ”—</span> GitHub
                        </button>
                    </div>
                </div>
                <div class="content-area" id="contentArea"></div>
            </main>
        </div>

        <div class="modal-overlay" id="settingsModal">
            <div class="modal">
                <div class="form-group">
                    <label class="form-label">GitHub ç”¨æˆ·å</label>
                    <input type="text" class="form-input" id="githubUsername" />
                </div>
                <div class="form-group">
                    <label class="form-label">ä»“åº“åç§°</label>
                    <input type="text" class="form-input" id="githubRepo" />
                </div>
                <div class="form-group">
                    <label class="form-label">æ–‡æ¡£è·¯å¾„ (å¯é€‰)</label>
                    <input
                        type="text"
                        class="form-input"
                        id="githubPath"
                        placeholder="ä¾‹å¦‚: docs"
                    />
                </div>
                <div class="modal-actions">
                    <button class="btn" id="settingsCancel">å–æ¶ˆ</button>
                    <button class="btn primary" id="settingsSave">
                        ä¿å­˜é…ç½®
                    </button>
                </div>
            </div>
        </div>
        <div class="toast" id="toast"></div>

        <script>
            // --- Config Manager ---
            class ConfigManager {
                constructor() {
                    this.config = this.loadConfig();
                    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆé…ç½®ï¼Œå°è¯•ä» URL è‡ªåŠ¨æ£€æµ‹
                    if (!this.isValid()) {
                        this.autoDetectFromUrl();
                    }
                }
                loadConfig() {
                    const stored = localStorage.getItem("blog_config");
                    return stored
                        ? JSON.parse(stored)
                        : { username: "", repo: "", path: "" };
                }
                saveConfig(config) {
                    this.config = { ...config };
                    localStorage.setItem(
                        "blog_config",
                        JSON.stringify(this.config),
                    );
                }
                isValid() {
                    return this.config.username && this.config.repo;
                }
                // ä» URL è‡ªåŠ¨æ£€æµ‹é…ç½®
                autoDetectFromUrl() {
                    const url = window.location.href;
                    const urlObj = new URL(url);
                    const hostname = urlObj.hostname;
                    const pathname = urlObj.pathname.replace(/\/$/, ""); // å»é™¤æœ«å°¾æ–œæ 

                    // 1. ä¼˜å…ˆæ£€æŸ¥ URL å‚æ•°ï¼ˆæ‰‹åŠ¨è¦†ç›–ï¼‰
                    const params = new URLSearchParams(urlObj.search);
                    if (params.has("user") || params.has("repo")) {
                        const username =
                            params.get("user") || params.get("username");
                        const repo = params.get("repo");
                        const path = params.get("path") || "";
                        if (username && repo) {
                            this.saveConfig({ username, repo, path });
                            return true;
                        }
                    }

                    // 2. ä» GitHub Pages URL è‡ªåŠ¨æå–
                    let username = "",
                        repo = "",
                        path = "";

                    // å¤„ç†ä¸åŒæ ¼å¼çš„ GitHub Pages URL
                    if (hostname === "github.io") {
                        // æ ‡å‡†æ ¼å¼: https://github.io/username/repo/...
                        const parts = pathname.split("/").filter((p) => p);
                        if (parts.length >= 2) {
                            username = parts[0];
                            repo = parts[1];
                            path = parts.slice(2).join("/");
                        }
                    } else if (hostname.endsWith(".github.io")) {
                        // é¡¹ç›®é¡µé¢: https://username.github.io/repo/...
                        username = hostname.replace(".github.io", "");
                        const parts = pathname.split("/").filter((p) => p);
                        if (parts.length >= 1) {
                            repo = parts[0];
                            path = parts.slice(1).join("/");
                        }
                    }

                    // 3. å¦‚æœæ²¡æœ‰æå–åˆ°è·¯å¾„ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„ 'notes'
                    if (username && repo && !path) {
                        path = "notes";
                    }

                    if (username && repo) {
                        this.saveConfig({ username, repo, path });
                        console.log("è‡ªåŠ¨æ£€æµ‹é…ç½®:", { username, repo, path });
                        return true;
                    }
                    return false;
                }
                getApiUrl(subPath = "") {
                    const { username, repo, path } = this.config;
                    let fullPath = path;
                    if (subPath) fullPath = subPath;
                    return `https://api.github.com/repos/${username}/${repo}/contents/${fullPath || ""}`;
                }
                getRepoUrl() {
                    return `https://github.com/${this.config.username}/${this.config.repo}`;
                }
            }

            // --- Data Manager ---
            class DataManager {
                constructor(configManager) {
                    this.configManager = configManager;
                    this.cache = new Map();
                }
                async fetchPath(path = "") {
                    const url = this.configManager.getApiUrl(path);
                    if (this.cache.has(url)) return this.cache.get(url);
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("è·å–å¤±è´¥");
                    const data = await res.json();
                    const processed = this.processData(data);
                    this.cache.set(url, processed);
                    return processed;
                }
                processData(data) {
                    if (!Array.isArray(data)) data = [data];
                    return data
                        .map((item) => ({
                            type: item.type === "dir" ? "folder" : "file",
                            name: item.name.replace(/\.md$/, ""),
                            path: item.path,
                            download_url: item.download_url,
                        }))
                        .filter(
                            (i) =>
                                i.type === "folder" || i.path.endsWith(".md"),
                        );
                }
                async getRaw(url) {
                    const res = await fetch(url);
                    return await res.text();
                }
            }

            // --- UI Manager ---
            class UIManager {
                constructor(config, data) {
                    this.configManager = config;
                    this.dataManager = data;
                    this.init();
                }
                init() {
                    this.bindEvents();
                    if (this.configManager.isValid()) {
                        // æ˜¾ç¤ºè‡ªåŠ¨æ£€æµ‹çš„é…ç½®ä¿¡æ¯
                        const { username, repo, path } =
                            this.configManager.config;
                        console.log("å½“å‰é…ç½®:", { username, repo, path });
                        this.showToast(
                            `å·²è‡ªåŠ¨é…ç½®: ${username}/${repo}${path ? "/" + path : ""}`,
                        );
                        this.refreshData();
                    } else {
                        this.showSettings();
                    }
                }
                bindEvents() {
                    document.getElementById("settingsBtn").onclick = () =>
                        this.showSettings();
                    document.getElementById("settingsSave").onclick = () =>
                        this.saveSettings();
                    document.getElementById("settingsCancel").onclick = () =>
                        this.hideModal("settingsModal");
                    document.getElementById("refreshBtn").onclick = () =>
                        this.refreshData();
                    document.getElementById("githubBtn").onclick = () => {
                        if (this.configManager.isValid()) {
                            window.open(
                                this.configManager.getRepoUrl(),
                                "_blank",
                            );
                        } else {
                            this.showToast("è¯·å…ˆé…ç½®GitHubä»“åº“");
                            setTimeout(() => this.showSettings(), 500);
                        }
                    };

                    // ç§»åŠ¨ç«¯èœå•äº¤äº’
                    const mobileMenuBtn =
                        document.getElementById("mobileMenuBtn");
                    const sidebar = document.getElementById("sidebar");
                    const mobileOverlay =
                        document.getElementById("mobileOverlay");

                    if (mobileMenuBtn) {
                        mobileMenuBtn.onclick = () => {
                            sidebar.classList.toggle("open");
                            mobileOverlay.classList.toggle("active");
                        };
                    }

                    if (mobileOverlay) {
                        mobileOverlay.onclick = () => {
                            sidebar.classList.remove("open");
                            mobileOverlay.classList.remove("active");
                        };
                    }

                    // ç‚¹å‡»å¯¼èˆªé¡¹åè‡ªåŠ¨å…³é—­ç§»åŠ¨ç«¯èœå•
                    document.addEventListener("click", (e) => {
                        if (
                            e.target.closest(".nav-item-content") &&
                            window.innerWidth <= 1024
                        ) {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ï¼ˆä¸æ˜¯æ–‡ä»¶å¤¹ï¼‰
                            const navItem = e.target.closest(".nav-item");
                            if (navItem) {
                                const toggle =
                                    navItem.querySelector(".nav-toggle");
                                // å¦‚æœæ²¡æœ‰ toggle è¯´æ˜æ˜¯æ–‡ä»¶ï¼Œç‚¹å‡»åå…³é—­èœå•
                                if (!toggle || toggle.textContent === "") {
                                    setTimeout(() => {
                                        sidebar.classList.remove("open");
                                        mobileOverlay.classList.remove(
                                            "active",
                                        );
                                    }, 300);
                                }
                            }
                        }
                    });

                    // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®èœå•çŠ¶æ€
                    window.addEventListener("resize", () => {
                        if (window.innerWidth > 1024) {
                            sidebar.classList.remove("open");
                            mobileOverlay.classList.remove("active");
                            document.body.style.overflow = "";
                        }
                    });

                    // é˜²æ­¢ç§»åŠ¨ç«¯èœå•æ‰“å¼€æ—¶é¡µé¢æ»šåŠ¨
                    const toggleBodyScroll = (disable) => {
                        document.body.style.overflow = disable ? "hidden" : "";
                    };

                    // ç›‘å¬èœå•çŠ¶æ€å˜åŒ–ï¼Œæ§åˆ¶é¡µé¢æ»šåŠ¨
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (
                                mutation.type === "attributes" &&
                                mutation.attributeName === "class"
                            ) {
                                const isOpen =
                                    sidebar.classList.contains("open");
                                toggleBodyScroll(isOpen);
                            }
                        });
                    });

                    if (sidebar) {
                        observer.observe(sidebar, { attributes: true });
                    }

                    // æ¨¡æ€æ¡†äº¤äº’ä¼˜åŒ–
                    const settingsModal =
                        document.getElementById("settingsModal");
                    if (settingsModal) {
                        // ç‚¹å‡»é®ç½©å±‚å…³é—­æ¨¡æ€æ¡†
                        settingsModal.onclick = (e) => {
                            if (e.target === settingsModal) {
                                this.hideModal("settingsModal");
                            }
                        };

                        // ESC é”®å…³é—­æ¨¡æ€æ¡†
                        document.addEventListener("keydown", (e) => {
                            if (e.key === "Escape") {
                                if (
                                    settingsModal.classList.contains("active")
                                ) {
                                    this.hideModal("settingsModal");
                                }
                                // åŒæ—¶å…³é—­ç§»åŠ¨ç«¯èœå•
                                if (sidebar.classList.contains("open")) {
                                    sidebar.classList.remove("open");
                                    mobileOverlay.classList.remove("active");
                                }
                            }
                        });

                        // ç§»åŠ¨ç«¯æ¨¡æ€æ¡†è§¦æ‘¸ä¼˜åŒ–
                        if (window.innerWidth <= 768) {
                            const modalContent =
                                settingsModal.querySelector(".modal");
                            if (modalContent) {
                                // é˜²æ­¢æ¨¡æ€æ¡†å†…å®¹æ»šåŠ¨æ—¶ç©¿é€åˆ°èƒŒæ™¯
                                modalContent.addEventListener(
                                    "touchmove",
                                    (e) => {
                                        e.stopPropagation();
                                    },
                                );
                            }
                        }
                    }
                }
                showToast(msg) {
                    const t = document.getElementById("toast");
                    t.innerText = msg;
                    t.classList.add("show");
                    setTimeout(() => t.classList.remove("show"), 2000);
                }
                showSettings() {
                    const { username, repo, path } = this.configManager.config;
                    document.getElementById("githubUsername").value = username;
                    document.getElementById("githubRepo").value = repo;
                    document.getElementById("githubPath").value = path;
                    document
                        .getElementById("settingsModal")
                        .classList.add("active");
                }
                hideModal(id) {
                    document.getElementById(id).classList.remove("active");
                }
                saveSettings() {
                    this.configManager.saveConfig({
                        username: document
                            .getElementById("githubUsername")
                            .value.trim(),
                        repo: document
                            .getElementById("githubRepo")
                            .value.trim(),
                        path: document
                            .getElementById("githubPath")
                            .value.trim(),
                    });
                    this.hideModal("settingsModal");
                    this.refreshData();
                }
                async refreshData() {
                    if (!this.configManager.isValid()) return;
                    const tree = document.getElementById("navTree");
                    // ç§»åŠ¨ç«¯ä¼˜åŒ–åŠ è½½æç¤º
                    const loadingMsg =
                        window.innerWidth <= 768 ? "åŠ è½½ä¸­..." : "åŠ è½½ä¸­...";
                    tree.innerHTML = `<div style='padding:16px; text-align: center; color: var(--text-tertiary);'>${loadingMsg}</div>`;
                    try {
                        const data = await this.dataManager.fetchPath();
                        this.renderTree(tree, data);
                        this.showToast("åŒæ­¥æˆåŠŸ");
                    } catch (e) {
                        this.showToast("åŒæ­¥å¤±è´¥: " + e.message);
                    }
                }
                renderTree(container, items) {
                    container.innerHTML = "";
                    items.forEach((item) => {
                        const div = document.createElement("div");
                        div.className = "nav-item";
                        div.innerHTML = `
                        <div class="nav-item-content">
                            <span class="nav-toggle">${item.type === "folder" ? "â–¶" : ""}</span>
                            <span class="nav-text">${item.name}</span>
                        </div>
                        <div class="nav-children"></div>
                    `;
                        const content = div.querySelector(".nav-item-content");
                        content.onclick = async () => {
                            if (item.type === "folder") {
                                const childDom =
                                    div.querySelector(".nav-children");
                                const toggle = div.querySelector(".nav-toggle");
                                const isExpanded =
                                    childDom.style.display === "block";

                                if (isExpanded) {
                                    // æ”¶èµ·
                                    requestAnimationFrame(() => {
                                        childDom.style.display = "none";
                                        toggle.classList.remove("expanded");
                                    });
                                } else {
                                    // å±•å¼€
                                    if (!childDom.innerHTML) {
                                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                                        content.classList.add("loading");
                                        const loadingDiv =
                                            document.createElement("div");
                                        loadingDiv.className = "nav-loading";
                                        loadingDiv.textContent = "åŠ è½½ä¸­...";
                                        childDom.appendChild(loadingDiv);
                                        childDom.style.display = "block";

                                        // å¼‚æ­¥åŠ è½½æ•°æ®
                                        setTimeout(async () => {
                                            try {
                                                const children =
                                                    await this.dataManager.fetchPath(
                                                        item.path,
                                                    );
                                                childDom.innerHTML = "";
                                                requestAnimationFrame(() => {
                                                    this.renderTree(
                                                        childDom,
                                                        children,
                                                    );
                                                    content.classList.remove(
                                                        "loading",
                                                    );
                                                });
                                            } catch (e) {
                                                childDom.innerHTML = `<div class="nav-loading" style="color: #ef4444;">åŠ è½½å¤±è´¥</div>`;
                                                content.classList.remove(
                                                    "loading",
                                                );
                                            }
                                        }, 10);
                                    } else {
                                        requestAnimationFrame(() => {
                                            childDom.style.display = "block";
                                            toggle.classList.add("expanded");
                                        });
                                    }
                                }
                            } else {
                                this.loadFile(item);
                            }
                        };
                        container.appendChild(div);
                    });
                }
                async loadFile(item) {
                    document.getElementById("toolbarTitle").innerText =
                        item.name;
                    const area = document.getElementById("contentArea");

                    // ç§»åŠ¨ç«¯æ˜¾ç¤ºåŠ è½½çŠ¶æ€ä¼˜åŒ–
                    const loadingText =
                        window.innerWidth <= 768
                            ? "åŠ è½½ä¸­..."
                            : "è¯»å–å†…å®¹ä¸­...";
                    area.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-tertiary);">${loadingText}</div>`;

                    try {
                        const md = await this.dataManager.getRaw(
                            item.download_url,
                        );
                        // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ¸²æŸ“
                        requestAnimationFrame(() => {
                            area.innerHTML = `<div class="markdown-body">${marked.parse(md)}</div>`;
                            // ç§»åŠ¨ç«¯è‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨
                            if (window.innerWidth <= 1024) {
                                area.scrollTop = 0;
                            }
                        });
                    } catch (e) {
                        // ç§»åŠ¨ç«¯é”™è¯¯æç¤ºä¼˜åŒ–
                        const errorText =
                            window.innerWidth <= 768
                                ? "åŠ è½½å¤±è´¥"
                                : "è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•";
                        area.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444;">${errorText}</div>`;
                    }
                }
            }

            // --- Start App ---
            const config = new ConfigManager();
            const data = new DataManager(config);
            const ui = new UIManager(config, data);
        </script>
    </body>
</html>
