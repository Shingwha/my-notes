<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>My Notes - GitHub ç¬”è®°æµè§ˆ</title>
        <!-- å¤–éƒ¨ä¾èµ– -->
        <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
        <style>
            :root {
                --bg-primary: #0a0a0a;
                --bg-secondary: #0f0f10;
                --bg-tertiary: #161618;
                --border-color: #27272a;
                --text-primary: #fafafa;
                --text-secondary: #a1a1aa;
                --text-tertiary: #52525b;
                --accent-color: #22d3ee;
                --hover-bg: #1e1e20;
                --active-bg: #27272a;
                --active-border: #22d3ee;
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                overflow: hidden;
                height: 100vh;
            }
            .container {
                display: flex;
                height: 100vh;
                overflow: hidden;
            }
            /* Sidebar Styles */
            .sidebar {
                width: 260px;
                min-width: 260px;
                background: var(--bg-secondary);
                border-right: 1px solid var(--border-color);
                display: flex;
                flex-direction: column;
                z-index: 100;
                transition:
                    transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                    margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .sidebar-header {
                padding: 16px;
                border-bottom: 1px solid var(--border-color);
            }
            .header-top {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 12px;
            }
            .logo {
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                color: var(--text-secondary);
                cursor: pointer;
                transition: color 0.2s;
            }
            .logo:hover {
                color: var(--text-primary);
            }
            .header-actions {
                display: flex;
                gap: 8px;
            }
            .search-box {
                position: relative;
                margin-top: 8px;
            }
            .search-input {
                width: 100%;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 7px 12px;
                padding-left: 32px;
                border-radius: 8px;
                font-size: 13px;
                outline: none;
                transition: border-color 0.2s;
            }
            .search-input:focus {
                border-color: var(--accent-color);
            }
            .search-icon {
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-tertiary);
                font-size: 12px;
            }
            .nav-tree {
                flex: 1;
                overflow-y: auto;
                padding: 12px 0;
                scrollbar-width: thin;
                scrollbar-color: transparent transparent;
                transition: scrollbar-color 0.3s;
            }
            .nav-tree:hover {
                scrollbar-color: var(--border-color) transparent;
            }
            .nav-tree::-webkit-scrollbar {
                width: 4px;
            }
            .nav-tree::-webkit-scrollbar-thumb {
                background: transparent;
                border-radius: 10px;
            }
            .nav-tree:hover::-webkit-scrollbar-thumb {
                background: var(--border-color);
            }

            .nav-item-content {
                display: flex;
                align-items: center;
                padding: 7px 16px;
                cursor: pointer;
                border-left: 3px solid transparent;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .nav-item-content:hover {
                background: var(--hover-bg);
            }
            .nav-item-content.active {
                background: var(--active-bg);
                border-left-color: var(--active-border);
            }
            .nav-text {
                flex: 1;
                font-size: 13px;
                color: var(--text-secondary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .nav-item-content.active .nav-text {
                color: var(--text-primary);
            }
            .nav-toggle {
                width: 18px;
                font-size: 9px;
                color: var(--text-tertiary);
                transition: transform 0.3s;
                display: inline-block;
                text-align: center;
                margin-right: 4px;
            }
            .nav-toggle.expanded {
                transform: rotate(90deg);
                color: var(--accent-color);
            }
            .nav-children {
                margin-left: 14px;
                border-left: 1px solid var(--border-color);
                display: none;
            }
            .nav-children.show {
                display: block;
            }

            /* Main Content Styles */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-width: 0;
                background: var(--bg-primary);
                transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .toolbar {
                height: 56px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                background: rgba(10, 10, 10, 0.8);
                backdrop-filter: blur(12px);
                z-index: 50;
                position: sticky;
                top: 0;
            }
            .toolbar-left {
                display: flex;
                align-items: center;
                gap: 16px;
                min-width: 0;
            }
            .toolbar-title {
                font-size: 14px;
                font-weight: 500;
                color: var(--text-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                letter-spacing: 0.3px;
            }
            .content-viewport {
                flex: 1;
                overflow-y: auto;
                scroll-behavior: smooth;
                scrollbar-width: thin;
                scrollbar-color: transparent transparent;
            }
            .content-viewport:hover {
                scrollbar-color: var(--border-color) transparent;
            }
            .content-viewport::-webkit-scrollbar {
                width: 6px;
            }
            .content-viewport::-webkit-scrollbar-thumb {
                background: transparent;
                border-radius: 10px;
            }
            .content-viewport:hover::-webkit-scrollbar-thumb {
                background: var(--border-color);
            }

            .content-area {
                padding: 60px 80px;

                max-width: 880px;

                margin: 0 auto;

                width: 100%;
            }

            /* Markdown Styles - Industry Standard Refined */

            .markdown-body {
                line-height: 1.75;

                color: #d1d5db; /* Neutral gray-white */

                font-size: 16px;

                word-wrap: break-word;
            }

            /* Headers */

            .markdown-body h1,
            .markdown-body h2,
            .markdown-body h3,
            .markdown-body h4 {
                color: var(--text-primary);

                font-weight: 600;

                line-height: 1.25;

                margin-top: 1.6em;

                margin-bottom: 0.8em;
            }

            .markdown-body h1 {
                font-size: 2.25em;

                padding-bottom: 0.3em;

                border-bottom: 1px solid var(--border-color);

                margin-top: 0;
            }

            .markdown-body h2 {
                font-size: 1.5em;

                padding-bottom: 0.3em;

                border-bottom: 1px solid var(--border-color);
            }

            .markdown-body h3 {
                font-size: 1.25em;
            }

            /* Paragraphs & Lists */

            .markdown-body p {
                margin-bottom: 1.2em;
            }

            .markdown-body ul,
            .markdown-body ol {
                margin-bottom: 1.2em;

                padding-left: 2em;
            }

            .markdown-body li {
                margin-bottom: 0.4em;
            }

            .markdown-body li > ul,
            .markdown-body li > ol {
                margin-top: 0.4em;

                margin-bottom: 0;
            }

            /* Links */

            .markdown-body a {
                color: var(--accent-color);

                text-decoration: none;

                transition: opacity 0.2s;
            }

            .markdown-body a:hover {
                text-decoration: underline;

                opacity: 0.8;
            }

            /* Blockquotes */

            .markdown-body blockquote {
                margin: 1.5em 0;

                padding: 0.6em 1.2em;

                color: var(--text-secondary);

                border-left: 4px solid var(--accent-color);

                background: rgba(255, 255, 255, 0.02);

                border-radius: 0 6px 6px 0;
            }

            .markdown-body blockquote p {
                margin-bottom: 0;
            }

            /* Code & Pre */

            .markdown-body code {
                font-family:
                    ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas,
                    "Liberation Mono", monospace;

                font-size: 0.9em;

                background: rgba(255, 255, 255, 0.08);

                padding: 0.2em 0.4em;

                border-radius: 4px;

                color: #f472b6; /* Soft pink for inline code */
            }

            .markdown-body pre {
                margin: 1.5em 0;

                padding: 20px;

                background: #0d0d0e;

                border-radius: 12px;

                overflow: auto;

                border: 1px solid var(--border-color);

                line-height: 1.5;
            }

            .markdown-body pre code {
                background: none;

                padding: 0;

                font-size: 0.9em;

                color: #e5e7eb;

                border-radius: 0;
            }

            /* Tables */

            .markdown-body table {
                width: 100%;

                border-collapse: collapse;

                margin: 1.5em 0;

                font-size: 0.95em;
            }

            .markdown-body th,
            .markdown-body td {
                padding: 10px 14px;

                border: 1px solid var(--border-color);

                text-align: left;
            }

            .markdown-body th {
                background: rgba(255, 255, 255, 0.03);

                font-weight: 600;
            }

            .markdown-body tr:nth-child(2n) {
                background: rgba(255, 255, 255, 0.01);
            }

            /* Divider */

            .markdown-body hr {
                height: 1px;

                background: var(--border-color);

                border: none;

                margin: 2.5em 0;
            }

            /* Images */

            .markdown-body img {
                max-width: 100%;

                border-radius: 8px;

                margin: 1.5em 0;

                display: block;
            }

            /* KaTeX Custom Styles */
            .katex-display {
                margin: 1.2em 0 !important;
                overflow-x: auto;
                overflow-y: hidden;
                scrollbar-width: thin;
            }
            .katex {
                font-size: 1.1em;
                color: inherit;
            }

            /* Components */
            .icon-btn {
                width: 34px;
                height: 34px;
                border: 1px solid var(--border-color);
                background: transparent;
                color: var(--text-secondary);
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }
            .icon-btn:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
                border-color: var(--text-tertiary);
            }

            .btn {
                padding: 6px 16px;
                border: 1px solid var(--border-color);
                background: transparent;
                color: var(--text-secondary);
                cursor: pointer;
                border-radius: 8px;
                font-size: 13px;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            .btn:hover {
                background: var(--hover-bg);
                color: var(--text-primary);
                border-color: var(--text-tertiary);
            }
            .btn.primary {
                background: var(--accent-color);
                color: #000;
                border-color: var(--accent-color);
                font-weight: 600;
                box-shadow: 0 0 15px rgba(34, 211, 238, 0.2);
            }
            .btn.primary:hover {
                opacity: 0.9;
                transform: translateY(-1px);
                box-shadow: 0 4px 20px rgba(34, 211, 238, 0.4);
            }

            .modal-actions {
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                margin-top: 24px;
            }

            /* Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            .modal-overlay.active {
                display: flex;
            }
            .modal {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                width: 100%;
                max-width: 400px;
                padding: 24px;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            }
            .modal-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 20px;
                color: var(--text-primary);
            }
            .form-group {
                margin-bottom: 16px;
            }
            .form-label {
                display: block;
                font-size: 12px;
                color: var(--text-secondary);
                margin-bottom: 6px;
                font-weight: 500;
            }
            .form-input {
                width: 100%;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                color: var(--text-primary);
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 13px;
                outline: none;
                transition: border-color 0.2s;
            }
            .form-input:focus {
                border-color: var(--accent-color);
            }

            /* Toast Styles */
            .toast {
                position: fixed;
                bottom: 24px;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: var(--accent-color);
                color: #000;
                padding: 8px 16px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 500;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 2000;
                pointer-events: none;
            }
            .toast.show {
                transform: translateX(-50%) translateY(0);
            }

            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 90;
                display: none;
            }

            .mobile-menu-btn {
                display: flex; /* Always visible as per request */
            }

            .sidebar.collapsed {
                margin-left: -260px;
                transform: translateX(0);
            }

            @media (max-width: 1024px) {
                .sidebar {
                    position: fixed;
                    top: 0;
                    bottom: 0;
                    left: 0;
                    transform: translateX(-100%);
                    margin-left: 0 !important;
                }
                .sidebar.open {
                    transform: translateX(0);
                }
                .content-area {
                    padding: 32px 24px;
                }
                .mobile-overlay.active {
                    display: block;
                }
            }

            /* Placeholder and status */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-tertiary);
            }
            .loading-spinner {
                border: 2px solid var(--border-color);
                border-top: 2px solid var(--accent-color);
                border-radius: 50%;
                width: 24px;
                height: 24px;
                animation: spin 1s linear infinite;
                margin: 0 auto 12px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="header-top">
                        <div class="logo" id="sidebarLogo">My Notes</div>
                        <div class="header-actions">
                            <button
                                class="icon-btn"
                                id="refreshBtn"
                                title="åˆ·æ–°"
                            >
                                â†»
                            </button>
                            <button
                                class="icon-btn"
                                id="settingsBtn"
                                title="é…ç½®"
                            >
                                âš™
                            </button>
                        </div>
                    </div>
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input
                            type="text"
                            class="search-input"
                            id="searchInput"
                            placeholder="æœç´¢ç¬”è®°..."
                        />
                    </div>
                </div>
                <div class="nav-tree" id="navTree"></div>
            </aside>

            <div class="mobile-overlay" id="mobileOverlay"></div>

            <!-- Main Content -->
            <main class="main-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button
                            class="icon-btn mobile-menu-btn"
                            id="mobileMenuBtn"
                        >
                            â˜°
                        </button>
                        <div class="toolbar-title" id="toolbarTitle">
                            é€‰æ‹©ä¸€ä¸ªç¬”è®°
                        </div>
                    </div>
                    <div class="toolbar-actions">
                        <button class="icon-btn" id="githubBtn" title="GitHub">
                            <svg
                                width="16"
                                height="16"
                                viewBox="0 0 16 16"
                                fill="currentColor"
                            >
                                <path
                                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
                                ></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="content-viewport" id="contentViewport">
                    <div class="content-area" id="contentArea">
                        <div class="empty-state">
                            <div
                                class="logo"
                                style="
                                    font-size: 24px;
                                    margin-bottom: 16px;
                                    opacity: 0.5;
                                "
                            >
                                NOTES
                            </div>
                            <p>ä»å·¦ä¾§ç›®å½•é€‰æ‹©ä¸€ä¸ª Markdown æ–‡ä»¶å¼€å§‹é˜…è¯»</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal">
            <div class="modal">
                <h3 class="modal-title">ä»“åº“é…ç½®</h3>
                <div class="form-group">
                    <label class="form-label">GitHub ç”¨æˆ·å / ç»„ç»‡</label>
                    <input
                        type="text"
                        class="form-input"
                        id="githubUsername"
                        placeholder="ä¾‹å¦‚: ShingWha"
                    />
                </div>
                <div class="form-group">
                    <label class="form-label">ä»“åº“åç§°</label>
                    <input
                        type="text"
                        class="form-input"
                        id="githubRepo"
                        placeholder="ä¾‹å¦‚: my-notes"
                    />
                </div>
                <div class="form-group">
                    <label class="form-label">æ ¹ç›®å½•è·¯å¾„ (å¯é€‰)</label>
                    <input
                        type="text"
                        class="form-input"
                        id="githubPath"
                        placeholder="ä¾‹å¦‚: notes"
                    />
                </div>
                <div class="form-group">
                    <label class="form-label"
                        >GitHub Token (ç§æœ‰ä»“åº“å¿…å¡«)</label
                    >
                    <input
                        type="password"
                        class="form-input"
                        id="githubToken"
                        placeholder="ghp_xxxxxxxxxxxx"
                    />
                    <p
                        style="
                            font-size: 11px;
                            color: var(--text-tertiary);
                            margin-top: 4px;
                        "
                    >
                        Token ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ç¼“å­˜ä¸­
                    </p>
                </div>
                <div
                    class="modal-actions"
                    style="justify-content: space-between"
                >
                    <button
                        class="btn"
                        id="importUrlBtn"
                        title="ä»å½“å‰æµè§ˆå™¨åœ°å€è§£æé…ç½®"
                    >
                        ä» URL å¯¼å…¥
                    </button>
                    <div style="display: flex; gap: 12px">
                        <button class="btn" id="settingsCancel">å–æ¶ˆ</button>
                        <button class="btn primary" id="settingsSave">
                            ä¿å­˜å¹¶åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            /**
             * é…ç½®ç®¡ç†æ¨¡å—
             */
            class ConfigManager {
                constructor() {
                    this.config = this.loadConfig();
                    // ä¼˜å…ˆçº§ï¼šURL å‚æ•° > Hash è·¯ç”± > åŸŸåæ£€æµ‹ > æœ¬åœ°å­˜å‚¨
                    const urlCfg = this.autoDetectFromUrl();
                    if (urlCfg) {
                        this.config = { ...this.config, ...urlCfg };
                    }
                }

                loadConfig() {
                    const stored = localStorage.getItem("blog_config_v1");
                    if (stored) return JSON.parse(stored);
                    return { username: "", repo: "", path: "", token: "" };
                }

                saveConfig(config) {
                    this.config = { ...this.config, ...config };
                    localStorage.setItem(
                        "blog_config_v1",
                        JSON.stringify(this.config),
                    );
                }

                isValid() {
                    return this.config.username && this.config.repo;
                }

                autoDetectFromUrl() {
                    const url = new URL(window.location.href);
                    const params = url.searchParams;
                    let username = "",
                        repo = "",
                        path = "",
                        token = "";

                    // 1. URL å‚æ•°ä¼˜å…ˆ (?user=xxx&repo=xxx)
                    if (params.has("user") || params.has("username")) {
                        username = params.get("user") || params.get("username");
                        repo = params.get("repo") || "";
                        path = params.get("path") || "";
                        token = params.get("token") || "";
                    }

                    // 2. Hash è·¯ç”± (#/user/repo/...)
                    if (!username) {
                        const hash = window.location.hash.slice(1);
                        if (hash && hash.startsWith("/")) {
                            const parts = hash.split("/").filter((p) => p);
                            if (parts.length >= 2) {
                                username = parts[0];
                                repo = parts[1];
                                // æ³¨æ„ï¼šæ­¤å¤„ä¸è®¾ç½® pathï¼Œå› ä¸º hash åé¢çš„éƒ¨åˆ†æ˜¯å…·ä½“æ–‡ä»¶è·¯å¾„
                            }
                        }
                    }

                    // 3. GitHub Pages åŸŸå (username.github.io/repo)
                    if (!username) {
                        const hostname = url.hostname;
                        const pathname = url.pathname.replace(/\/$/, "");
                        if (hostname.endsWith(".github.io")) {
                            username = hostname.split(".")[0];
                            const parts = pathname.split("/").filter((p) => p);
                            if (parts.length >= 1) {
                                repo = parts[0];
                            }
                        }
                    }

                    if (username && repo) {
                        return { username, repo, path, token };
                    }
                    return null;
                }

                getApiUrl(subPath = "") {
                    const { username, repo, path } = this.config;
                    const fullPath = subPath || path || "";
                    return `https://api.github.com/repos/${username}/${repo}/contents/${fullPath}`;
                }

                getRepoUrl() {
                    return `https://github.com/${this.config.username}/${this.config.repo}`;
                }
            }

            /**
             * æ•°æ®äº¤äº’æ¨¡å—
             */
            class DataManager {
                constructor(configManager) {
                    this.configManager = configManager;
                    this.cache = new Map();
                    this.treeData = null; // å­˜å‚¨è½¬æ¢åçš„æ ‘å½¢ç»“æ„
                    this.isIndexing = false;
                }

                get headers() {
                    const h = { Accept: "application/vnd.github.v3+json" };
                    if (this.configManager.config.token) {
                        h["Authorization"] =
                            `token ${this.configManager.config.token}`;
                    }
                    return h;
                }

                // æ ¸å¿ƒæ”¹è¿›ï¼šä¸€æ¬¡æ€§è·å–å…¨åº“ç»“æ„å¹¶è½¬æ¢ä¸ºæ ‘å½¢
                async getFullTree() {
                    if (this.treeData) return this.treeData;

                    const {
                        username,
                        repo,
                        path: rootPath,
                    } = this.configManager.config;
                    // HEAD ä»£è¡¨é»˜è®¤åˆ†æ”¯
                    const url = `https://api.github.com/repos/${username}/${repo}/git/trees/HEAD?recursive=1`;

                    const res = await fetch(url, { headers: this.headers });
                    if (!res.ok) {
                        const errorMsg =
                            res.status === 401
                                ? "Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"
                                : res.status === 404
                                  ? "æ‰¾ä¸åˆ°ä»“åº“ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œä»“åº“å"
                                  : res.status === 403
                                    ? "æƒé™ä¸è¶³æˆ–è§¦å‘ API é™æµ"
                                    : `è¯·æ±‚å¤±è´¥ (ä»£ç : ${res.status})`;
                        throw new Error(`æ— æ³•ç´¢å¼•ä»“åº“: ${errorMsg}`);
                    }

                    const data = await res.json();

                    // 1. è¿‡æ»¤å‡ºç›®æ ‡è·¯å¾„ä¸‹çš„ .md æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
                    let rawItems = data.tree.filter((item) => {
                        // å¦‚æœè®¾ç½®äº†æ ¹è·¯å¾„ï¼Œåˆ™åªå¤„ç†è¯¥è·¯å¾„ä¸‹çš„æ–‡ä»¶
                        if (rootPath && !item.path.startsWith(rootPath))
                            return false;
                        // åªè¦æ–‡ä»¶å¤¹å’Œ .md æ–‡ä»¶
                        return (
                            item.type === "tree" ||
                            item.path.toLowerCase().endsWith(".md")
                        );
                    });

                    // 2. å°†æ‰å¹³è·¯å¾„è½¬æ¢ä¸ºåµŒå¥—æ ‘ç»“æ„
                    this.treeData = this.buildTree(rawItems, rootPath);
                    return this.treeData;
                }

                buildTree(items, rootPath) {
                    const result = [];
                    const map = { "": { children: result } };

                    // æ’åºç¡®ä¿çˆ¶çº§åœ¨å­çº§ä¹‹å‰
                    items.sort((a, b) => a.path.length - b.path.length);

                    items.forEach((item) => {
                        const path = item.path;
                        // å¦‚æœæœ‰ rootPathï¼Œè®¡ç®—ç›¸å¯¹è·¯å¾„
                        const relativePath = rootPath
                            ? path.replace(new RegExp(`^${rootPath}/?`), "")
                            : path;
                        if (!relativePath) return;

                        const parts = relativePath.split("/");
                        const name = parts.pop();
                        const parentPath = parts.join("/");

                        const node = {
                            name: name.replace(/\.md$/, ""),
                            path: path,
                            type: item.type === "tree" ? "folder" : "file",
                            children: [],
                            download_url:
                                item.type === "blob"
                                    ? `https://raw.githubusercontent.com/${this.configManager.config.username}/${this.configManager.config.repo}/HEAD/${path}`
                                    : null,
                        };

                        if (map[parentPath]) {
                            map[parentPath].children.push(node);
                        } else {
                            // å…œåº•ï¼šå¦‚æœæ‰¾ä¸åˆ°çˆ¶çº§ï¼ˆå¯èƒ½çˆ¶çº§è¢«è¿‡æ»¤äº†ï¼‰ï¼Œæ”¾æ ¹éƒ¨
                            result.push(node);
                        }

                        if (item.type === "tree") {
                            map[relativePath] = node;
                        }
                    });

                    // æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰ï¼Œæ–‡ä»¶ååœ¨å
                    const sortNodes = (nodes) => {
                        nodes.sort((a, b) => {
                            if (a.type !== b.type)
                                return a.type === "folder" ? -1 : 1;
                            return a.name.localeCompare(b.name);
                        });
                        nodes.forEach((n) => {
                            if (n.children.length) sortNodes(n.children);
                        });
                    };
                    sortNodes(result);

                    return result;
                }

                async getRawContent(item) {
                    const { username, repo } = this.configManager.config;
                    const hasToken = !!this.configManager.config.token;

                    // å¦‚æœæœ‰ Token (ç§æœ‰ä»“åº“)ï¼Œå¿…é¡»é€šè¿‡ API åŸŸåè·å–ï¼Œå¦åˆ™ä¼šè§¦å‘ CORS é”™è¯¯
                    if (hasToken) {
                        const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${item.path}`;
                        const res = await fetch(apiUrl, {
                            headers: {
                                ...this.headers,
                                Accept: "application/vnd.github.v3.raw", // å…³é”®ï¼šè¦æ±‚è¿”å›åŸå§‹æ–‡æœ¬è€Œé JSON
                            },
                        });
                        if (!res.ok) throw new Error(`API é”™è¯¯: ${res.status}`);
                        return await res.text();
                    } else {
                        // å…¬æœ‰ä»“åº“ç›´æ¥èµ° raw åŸŸåï¼Œä¸å¸¦ä»»ä½• Headers é¿å…è·¨åŸŸé—®é¢˜
                        const res = await fetch(item.download_url);
                        if (!res.ok)
                            throw new Error(`æ–‡ä»¶è·å–å¤±è´¥: ${res.status}`);
                        return await res.text();
                    }
                }
            }

            /**
             * ç•Œé¢ç®¡ç†æ¨¡å—
             */
            class UIManager {
                constructor(config, data) {
                    this.configManager = config;
                    this.dataManager = data;
                    this.searchMode = false;

                    this.dom = {
                        sidebar: document.getElementById("sidebar"),
                        navTree: document.getElementById("navTree"),
                        contentArea: document.getElementById("contentArea"),
                        contentViewport:
                            document.getElementById("contentViewport"),
                        toolbarTitle: document.getElementById("toolbarTitle"),
                        settingsModal: document.getElementById("settingsModal"),
                        searchInput: document.getElementById("searchInput"),
                        mobileOverlay: document.getElementById("mobileOverlay"),
                        sidebarLogo: document.getElementById("sidebarLogo"),
                    };

                    this.init();
                }

                init() {
                    // 1. å—çº§å…¬å¼æ‰©å±• ($$ ... $$)
                    const blockMath = {
                        name: "blockMath",
                        level: "block",
                        start(src) {
                            return src.indexOf("$$");
                        },
                        tokenizer(src, tokens) {
                            const cap = /^\$\$([\s\S]+?)\$\$/.exec(src);
                            if (cap) {
                                return {
                                    type: "blockMath",
                                    raw: cap[0],
                                    text: cap[1].trim(),
                                };
                            }
                        },
                        renderer(token) {
                            return `<div class="katex-display-wrapper">${katex.renderToString(token.text, { displayMode: true, throwOnError: false })}</div>`;
                        },
                    };

                    // 2. è¡Œå†…å…¬å¼æ‰©å±• ($ ... $)
                    const inlineMath = {
                        name: "inlineMath",
                        level: "inline",
                        start(src) {
                            return src.indexOf("$");
                        },
                        tokenizer(src, tokens) {
                            const cap = /^\$((?:[^\$]|\\\$)+?)\$/.exec(src);
                            if (cap) {
                                return {
                                    type: "inlineMath",
                                    raw: cap[0],
                                    text: cap[1].trim(),
                                };
                            }
                        },
                        renderer(token) {
                            return katex.renderToString(token.text, {
                                displayMode: false,
                                throwOnError: false,
                            });
                        },
                    };

                    marked.use({ extensions: [blockMath, inlineMath] });

                    // é…ç½® marked å…¨å±€é€‰é¡¹
                    marked.setOptions({
                        highlight: function (code, lang) {
                            if (window.Prism && Prism.languages[lang]) {
                                return Prism.highlight(
                                    code,
                                    Prism.languages[lang],
                                    lang,
                                );
                            }
                            return code;
                        },
                        breaks: true,
                        gfm: true,
                    });

                    this.bindEvents();
                    if (this.configManager.isValid()) {
                        this.refreshData();
                    } else {
                        this.showSettings();
                    }
                }

                bindEvents() {
                    this.dom.sidebarLogo.onclick = () => this.showHome();
                    document.getElementById("refreshBtn").onclick = () => {
                        this.dataManager.treeData = null;
                        this.refreshData();
                    };
                    document.getElementById("settingsBtn").onclick = () =>
                        this.showSettings();
                    document.getElementById("githubBtn").onclick = () => {
                        window.open(this.configManager.getRepoUrl(), "_blank");
                    };

                    this.dom.searchInput.oninput = (e) =>
                        this.handleSearch(e.target.value);

                    const toggleSidebar = () => {
                        if (window.innerWidth <= 1024) {
                            this.dom.sidebar.classList.toggle("open");
                            this.dom.mobileOverlay.classList.toggle("active");
                        } else {
                            this.dom.sidebar.classList.toggle("collapsed");
                        }
                    };
                    document.getElementById("mobileMenuBtn").onclick =
                        toggleSidebar;
                    this.dom.mobileOverlay.onclick = toggleSidebar;

                    document.getElementById("settingsSave").onclick = () =>
                        this.saveSettings();
                    document.getElementById("settingsCancel").onclick = () =>
                        this.hideModal();

                    window.onhashchange = () => this.handleRouting();

                    document.getElementById("importUrlBtn").onclick = () => {
                        const urlCfg = this.configManager.autoDetectFromUrl();
                        if (urlCfg) {
                            document.getElementById("githubUsername").value =
                                urlCfg.username;
                            document.getElementById("githubRepo").value =
                                urlCfg.repo;
                            document.getElementById("githubPath").value =
                                urlCfg.path;
                            if (urlCfg.token)
                                document.getElementById("githubToken").value =
                                    urlCfg.token;
                            this.showToast(
                                "å·²ä» URL æå–é…ç½®ï¼Œè¯·ç¡®è®¤åç‚¹å‡»ä¿å­˜",
                            );
                        } else {
                            this.showToast("å½“å‰ URL æœªåŒ…å«æœ‰æ•ˆçš„ä»“åº“ä¿¡æ¯");
                        }
                    };

                    document.addEventListener("keydown", (e) => {
                        if (e.key === "Escape") {
                            this.hideModal();
                            this.dom.sidebar.classList.remove("open");
                            this.dom.mobileOverlay.classList.remove("active");
                        }
                        if ((e.ctrlKey || e.metaKey) && e.key === "f") {
                            e.preventDefault();
                            this.dom.searchInput.focus();
                        }
                    });
                }

                showToast(msg, duration = 3000) {
                    const toast = document.getElementById("toast");
                    toast.textContent = msg;
                    toast.classList.add("show");
                    clearTimeout(this.toastTimer);
                    this.toastTimer = setTimeout(
                        () => toast.classList.remove("show"),
                        duration,
                    );
                }

                showSettings() {
                    const cfg = this.configManager.config;
                    document.getElementById("githubUsername").value =
                        cfg.username || "";
                    document.getElementById("githubRepo").value =
                        cfg.repo || "";
                    document.getElementById("githubPath").value =
                        cfg.path || "";
                    document.getElementById("githubToken").value =
                        cfg.token || "";
                    this.dom.settingsModal.classList.add("active");
                }

                hideModal() {
                    this.dom.settingsModal.classList.remove("active");
                }

                saveSettings() {
                    const username = document
                        .getElementById("githubUsername")
                        .value.trim();
                    const repo = document
                        .getElementById("githubRepo")
                        .value.trim();
                    const path = document
                        .getElementById("githubPath")
                        .value.trim();
                    const token = document
                        .getElementById("githubToken")
                        .value.trim();

                    if (!username || !repo) {
                        this.showToast("ç”¨æˆ·åå’Œä»“åº“åä¸ºå¿…å¡«é¡¹");
                        return;
                    }

                    this.configManager.saveConfig({
                        username,
                        repo,
                        path,
                        token,
                    });
                    this.hideModal();

                    // æ›´æ–° URL Hash ä»¥åŒ¹é…æ–°ä»“åº“
                    const newHash = `#/${username}/${repo}`;
                    if (window.location.hash !== newHash) {
                        window.location.hash = newHash;
                    } else {
                        // å¦‚æœ Hash æ²¡å˜ï¼Œæ‰‹åŠ¨è§¦å‘åˆ·æ–°
                        this.dataManager.treeData = null;
                        this.refreshData();
                    }
                }

                async refreshData() {
                    this.dom.navTree.innerHTML = `
                        <div class="empty-state">
                            <div class="loading-spinner"></div>
                            <p>æ­£åœ¨æ‹‰å–å…¨é‡ç´¢å¼•...</p>
                        </div>
                    `;
                    try {
                        const tree = await this.dataManager.getFullTree();
                        this.renderTree(this.dom.navTree, tree);
                        this.showToast("æ•°æ®åŒæ­¥æˆåŠŸ");
                        // æ•°æ®åŠ è½½å®Œæˆåï¼Œæ ¹æ® URL è·¯ç”±åˆ°å…·ä½“æ–‡ä»¶
                        this.handleRouting();
                    } catch (e) {
                        this.dom.navTree.innerHTML = `
                            <div class="empty-state">
                                <p style="color: #ef4444;">${e.message}</p>
                                <button class="btn" onclick="ui.showSettings()" style="margin-top:12px">æ£€æŸ¥é…ç½®</button>
                            </div>
                        `;
                    }
                }

                handleRouting() {
                    let hash = window.location.hash.slice(1);
                    if (!hash) {
                        this.showHome(true);
                        return;
                    }

                    try {
                        hash = decodeURIComponent(hash);
                    } catch (e) {
                        console.error("Malformed URI", e);
                    }

                    if (!hash.startsWith("/")) {
                        this.showHome(true);
                        return;
                    }

                    const parts = hash.split("/").filter((p) => p);
                    if (parts.length < 2) return;

                    const hashUser = parts[0];
                    const hashRepo = parts[1];
                    const currentCfg = this.configManager.config;

                    // æ ¸å¿ƒæ”¹è¿›ï¼šæ£€æµ‹æ˜¯å¦åˆ‡æ¢äº†ä»“åº“
                    if (
                        hashUser !== currentCfg.username ||
                        hashRepo !== currentCfg.repo
                    ) {
                        console.log(
                            `åˆ‡æ¢ä»“åº“: ${currentCfg.username}/${currentCfg.repo} -> ${hashUser}/${hashRepo}`,
                        );
                        // æ›´æ–°å½“å‰é…ç½®
                        this.configManager.config.username = hashUser;
                        this.configManager.config.repo = hashRepo;
                        this.configManager.config.path = ""; // åˆ‡æ¢ä»“åº“æ—¶é»˜è®¤æ¸…ç©ºå­è·¯å¾„
                        this.dataManager.treeData = null;
                        this.refreshData();
                        return;
                    }

                    if (parts.length <= 2) {
                        this.showHome(true);
                        return;
                    }

                    const filePath = parts.slice(2).join("/");

                    // åœ¨æ ‘ä¸­å¯»æ‰¾è¯¥æ–‡ä»¶
                    const findFile = (nodes) => {
                        for (const node of nodes) {
                            if (node.path === filePath) return node;
                            if (node.children && node.children.length) {
                                const found = findFile(node.children);
                                if (found) return found;
                            }
                        }
                        return null;
                    };

                    const tree = this.dataManager.treeData || [];
                    const targetNode = findFile(tree);
                    if (targetNode) {
                        this.setActiveFile(targetNode, true);
                    } else {
                        // å¦‚æœåœ¨å½“å‰æ ‘ä¸­æ‰¾ä¸åˆ°ï¼Œå¯èƒ½æ˜¯è¿˜æ²¡åŠ è½½å®Œæˆ–è€…è·¯å¾„ä¸å¯¹
                        console.warn("æœªåœ¨ç›®å½•æ ‘ä¸­æ‰¾åˆ°æ–‡ä»¶:", filePath);
                    }
                }

                showHome(isSilent = false) {
                    if (!isSilent) {
                        const url = new URL(window.location.href);
                        history.pushState(null, "", url.pathname + url.search);
                    }

                    this.dom.searchInput.value = "";
                    this.handleSearch("");

                    this.dom.toolbarTitle.textContent = "é€‰æ‹©ä¸€ä¸ªç¬”è®°";
                    document
                        .querySelectorAll(".nav-item-content")
                        .forEach((el) => {
                            el.classList.remove("active");
                        });

                    this.dom.contentArea.innerHTML = `
                        <div class="empty-state">
                            <div
                                class="logo"
                                style="
                                    font-size: 24px;
                                    margin-bottom: 16px;
                                    opacity: 0.5;
                                "
                            >
                                NOTES
                            </div>
                            <p>ä»å·¦ä¾§ç›®å½•é€‰æ‹©ä¸€ä¸ª Markdown æ–‡ä»¶å¼€å§‹é˜…è¯»</p>
                        </div>
                    `;
                }

                revealInTree(targetPath) {
                    // 1. æ¸…é™¤æ‰€æœ‰é«˜äº®
                    document
                        .querySelectorAll(".nav-item-content")
                        .forEach((el) => el.classList.remove("active"));

                    const parts = targetPath.split("/");
                    let currentPath = "";

                    // 2. é€å±‚å¯»æ‰¾å¹¶å±•å¼€æ–‡ä»¶å¤¹
                    for (let i = 0; i < parts.length; i++) {
                        currentPath = currentPath
                            ? `${currentPath}/${parts[i]}`
                            : parts[i];
                        const el = document.querySelector(
                            `.nav-item-content[data-path="${currentPath}"]`,
                        );

                        if (el) {
                            if (i < parts.length - 1) {
                                // æ˜¯ä¸­é—´æ–‡ä»¶å¤¹è·¯å¾„
                                const childrenDiv =
                                    el.parentElement.querySelector(
                                        ".nav-children",
                                    );
                                if (
                                    childrenDiv &&
                                    !childrenDiv.classList.contains("show")
                                ) {
                                    // ä»…åœ¨æœªå±•å¼€æ—¶æ¨¡æ‹Ÿç‚¹å‡»ï¼ˆè§¦å‘ renderTree å’Œæ ·å¼åˆ‡æ¢ï¼‰
                                    el.click();
                                }
                            } else {
                                // å·²ç»åˆ°è¾¾ç›®æ ‡æ–‡ä»¶
                                el.classList.add("active");
                                // ç¡®ä¿åœ¨è§†å£å¯è§
                                el.scrollIntoView({
                                    block: "nearest",
                                    behavior: "smooth",
                                });
                            }
                        }
                    }
                }

                renderTree(container, items, level = 0) {
                    if (level === 0) container.innerHTML = "";

                    items.forEach((item) => {
                        const div = document.createElement("div");
                        div.className = "nav-item";

                        const isFolder = item.type === "folder";
                        div.innerHTML = `
                            <div class="nav-item-content" data-path="${item.path}" style="padding-left: ${16 + level * 12}px">
                                <span class="nav-toggle">${isFolder ? "â–¶" : "â€¢"}</span>
                                <span class="nav-text" title="${item.name}">${item.name}</span>
                            </div>
                            ${isFolder ? '<div class="nav-children"></div>' : ""}
                        `;

                        const content = div.querySelector(".nav-item-content");
                        if (isFolder) {
                            const childrenDiv =
                                div.querySelector(".nav-children");
                            const toggle = div.querySelector(".nav-toggle");

                            content.onclick = (e) => {
                                e.stopPropagation();
                                const isExpanded =
                                    childrenDiv.classList.contains("show");
                                if (isExpanded) {
                                    childrenDiv.classList.remove("show");
                                    toggle.classList.remove("expanded");
                                } else {
                                    if (
                                        childrenDiv.innerHTML === "" &&
                                        item.children.length > 0
                                    ) {
                                        this.renderTree(
                                            childrenDiv,
                                            item.children,
                                            level + 1,
                                        );
                                    }
                                    childrenDiv.classList.add("show");
                                    toggle.classList.add("expanded");
                                }
                            };
                        } else {
                            content.onclick = (e) => {
                                e.stopPropagation();
                                this.setActiveFile(item);
                            };
                        }
                        container.appendChild(div);
                    });
                }

                async setActiveFile(item, isSilent = false) {
                    const { username, repo } = this.configManager.config;

                    // 1. æ›´æ–° URL Hash (æ ¼å¼: #/username/repo/path)
                    if (!isSilent) {
                        const newHash = `#/${username}/${repo}/${item.path}`;
                        if (window.location.hash !== newHash) {
                            history.pushState(null, "", newHash);
                        }
                    }

                    // 2. UI çŠ¶æ€æ›´æ–°ï¼šé«˜äº®å·¦ä¾§èœå•å¹¶å±•å¼€æ–‡ä»¶å¤¹
                    this.revealInTree(item.path);

                    this.dom.toolbarTitle.textContent = item.name;

                    if (window.innerWidth <= 1024) {
                        this.dom.sidebar.classList.remove("open");
                        this.dom.mobileOverlay.classList.remove("active");
                    }

                    this.dom.contentArea.innerHTML = `
                        <div class="empty-state">
                            <div class="loading-spinner"></div>
                            <p>æ­£åœ¨è¯»å– ${item.name}...</p>
                        </div>
                    `;

                    try {
                        const raw = await this.dataManager.getRawContent(item);
                        this.renderMarkdown(raw);
                        this.dom.contentViewport.scrollTop = 0;
                    } catch (e) {
                        this.dom.contentArea.innerHTML = `<div class="empty-state"><p style="color:#ef4444">åŠ è½½å†…å®¹å¤±è´¥: ${e.message}</p></div>`;
                    }
                }

                renderMarkdown(md) {
                    this.dom.contentArea.innerHTML = `<div class="markdown-body">${marked.parse(md)}</div>`;

                    if (window.Prism) {
                        this.dom.contentArea
                            .querySelectorAll("pre code")
                            .forEach((block) => {
                                Prism.highlightElement(block);
                            });
                    }
                }

                handleSearch(query) {
                    query = query.toLowerCase().trim();
                    if (!query) {
                        this.searchMode = false;
                        if (this.dataManager.treeData) {
                            this.renderTree(
                                this.dom.navTree,
                                this.dataManager.treeData,
                            );
                        }
                        return;
                    }

                    this.searchMode = true;
                    const results = [];
                    const flatten = (nodes) => {
                        nodes.forEach((n) => {
                            if (
                                n.type === "file" &&
                                n.name.toLowerCase().includes(query)
                            ) {
                                results.push(n);
                            }
                            if (n.children.length) flatten(n.children);
                        });
                    };
                    flatten(this.dataManager.treeData || []);

                    this.renderSearchResults(results);
                }

                renderSearchResults(results) {
                    this.dom.navTree.innerHTML = results.length
                        ? ""
                        : '<div class="empty-state"><p>æœªæ‰¾åˆ°ç›¸å…³ç¬”è®°</p></div>';
                    results.forEach((item) => {
                        const div = document.createElement("div");
                        div.className = "nav-item";
                        const dirPath = item.path
                            .split("/")
                            .slice(0, -1)
                            .join("/");

                        div.innerHTML = `
                            <div class="nav-item-content" data-path="${item.path}" style="padding: 10px 16px; flex-direction: column; align-items: flex-start; gap: 2px;">
                                <div class="nav-text" style="color: var(--text-primary); font-weight: 500;">${item.name}</div>
                                <div style="font-size: 11px; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">
                                    ${dirPath || "/"}
                                </div>
                            </div>
                        `;
                        div.onclick = () => this.setActiveFile(item);
                        this.dom.navTree.appendChild(div);
                    });
                }
            }

            // å¯åŠ¨åº”ç”¨
            const config = new ConfigManager();
            const data = new DataManager(config);
            const ui = new UIManager(config, data);

            // å…¨å±€æŒ‚è½½ä»¥ä¾¿è°ƒè¯•
            window.ui = ui;
        </script>
    </body>
</html>
