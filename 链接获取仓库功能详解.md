# GitHub 链接自动获取仓库功能详解

## 一、功能概述

该功能允许用户通过多种方式提供 GitHub 仓库信息，系统会自动解析并配置数据源，无需手动输入用户名和仓库名。

---

## 二、支持的链接格式

### 2.1 URL 参数方式（优先级最高）

**格式**: `?user={username}&repo={repo}&path={path}`

**示例**:
```
https://your-domain.com/index.html?user=ShingWha&repo=my-notes&path=notes
https://your-domain.com/index.html?username=ShingWha&repo=my-notes
```

**解析逻辑**:
```javascript
// 从 URLSearchParams 提取参数
const params = new URLSearchParams(urlObj.search);
if (params.has("user") || params.has("repo")) {
    const username = params.get("user") || params.get("username");
    const repo = params.get("repo");
    const path = params.get("path") || "";
    // 保存配置
    this.saveConfig({ username, repo, path });
}
```

---

### 2.2 GitHub Pages 标准格式

#### A. 组织/用户页面格式
**URL**: `https://github.io/{username}/{repo}/{path}`

**示例**:
```
https://github.io/ShingWha/my-notes/notes
https://github.io/ShingWha/my-notes/docs/guide
```

**解析代码**:
```javascript
if (hostname === "github.io") {
    const parts = pathname.split("/").filter((p) => p);
    if (parts.length >= 2) {
        username = parts[0];      // ShingWha
        repo = parts[1];          // my-notes
        path = parts.slice(2).join("/");  // notes/docs/guide
    }
}
```

#### B. 项目页面格式
**URL**: `https://{username}.github.io/{repo}/{path}`

**示例**:
```
https://shingwha.github.io/my-notes/notes
https://shingwha.github.io/my-notes/docs
```

**解析代码**:
```javascript
if (hostname.endsWith(".github.io")) {
    username = hostname.replace(".github.io", "");  // shingwha
    const parts = pathname.split("/").filter((p) => p);
    if (parts.length >= 1) {
        repo = parts[0];          // my-notes
        path = parts.slice(1).join("/");  // notes/docs
    }
}
```

---

### 2.3 GitHub 仓库直接链接

**URL**: `https://github.com/{username}/{repo}`

**处理方式**: 虽然当前代码主要针对 GitHub Pages，但可以扩展支持：

```javascript
// 扩展建议：支持 GitHub 仓库链接
else if (hostname === "github.com") {
    const parts = pathname.split("/").filter((p) => p);
    if (parts.length >= 2) {
        username = parts[0];
        repo = parts[1];
        path = "notes";  // 默认路径
    }
}
```

---

## 三、完整解析流程

### 3.1 优先级顺序

```
1. URL 参数 (?user=...&repo=...) → 最高优先级
2. GitHub Pages 标准格式 → 次优先级
3. 项目页面格式 → 第三优先级
4. localStorage 已存配置 → 最低优先级（兜底）
```

### 3.2 完整代码实现

```javascript
autoDetectFromUrl() {
    const url = window.location.href;
    const urlObj = new URL(url);
    const hostname = urlObj.hostname;
    const pathname = urlObj.pathname.replace(/\/$/, ""); // 去除末尾斜杠

    // 1. 优先检查 URL 参数（手动覆盖）
    const params = new URLSearchParams(urlObj.search);
    if (params.has("user") || params.has("repo")) {
        const username = params.get("user") || params.get("username");
        const repo = params.get("repo");
        const path = params.get("path") || "";
        if (username && repo) {
            this.saveConfig({ username, repo, path });
            return true;
        }
    }

    // 2. 从 GitHub Pages URL 自动提取
    let username = "", repo = "", path = "";

    // 处理不同格式的 GitHub Pages URL
    if (hostname === "github.io") {
        // 标准格式: https://github.io/username/repo/...
        const parts = pathname.split("/").filter((p) => p);
        if (parts.length >= 2) {
            username = parts[0];
            repo = parts[1];
            path = parts.slice(2).join("/");
        }
    } else if (hostname.endsWith(".github.io")) {
        // 项目页面: https://username.github.io/repo/...
        username = hostname.replace(".github.io", "");
        const parts = pathname.split("/").filter((p) => p);
        if (parts.length >= 1) {
            repo = parts[0];
            path = parts.slice(1).join("/");
        }
    }

    // 3. 如果没有提取到路径，使用默认路径 'notes'
    if (username && repo && !path) {
        path = "notes";
    }

    if (username && repo) {
        this.saveConfig({ username, repo, path });
        console.log("自动检测配置:", { username, repo, path });
        return true;
    }
    return false;
}
```

---

## 四、使用场景示例

### 场景 1: 用户直接访问
```
用户访问: https://shingwha.github.io/my-notes/

解析结果:
- username: shingwha
- repo: my-notes
- path: notes (自动添加默认路径)

API 请求: https://api.github.com/repos/shingwha/my-notes/contents/notes
```

### 场景 2: 分享特定笔记
```
用户访问: https://shingwha.github.io/my-notes/?user=ShingWha&repo=notes&path=docs/guide

解析结果:
- username: ShingWha
- repo: notes
- path: docs/guide

API 请求: https://api.github.com/repos/ShingWha/notes/contents/docs/guide
```

### 场景 3: 组织页面
```
用户访问: https://github.io/company/project/technical/docs

解析结果:
- username: company
- repo: project
- path: technical/docs

API 请求: https://api.github.com/repos/company/project/contents/technical/docs
```

---

## 五、初始化流程

### 5.1 应用启动顺序

```javascript
// 1. 创建 ConfigManager
const config = new ConfigManager();
//   ↓ 自动调用 constructor()
//   ↓ 调用 loadConfig() 读取 localStorage
//   ↓ 如果无效，调用 autoDetectFromUrl()

// 2. 创建 DataManager
const data = new DataManager(config);
//   ↓ 传入 ConfigManager 实例
//   ↓ 初始化缓存 Map

// 3. 创建 UIManager
const ui = new UIManager(config, data);
//   ↓ 调用 init()
//   ↓ 检查配置有效性
//   ↓ 显示配置或刷新数据
```

### 5.2 配置验证流程

```javascript
// UIManager.init() 中的逻辑
init() {
    this.bindEvents();
    if (this.configManager.isValid()) {
        // 配置有效 → 直接加载数据
        const { username, repo, path } = this.configManager.config;
        this.showToast(`已自动配置: ${username}/${repo}${path ? "/" + path : ""}`);
        this.refreshData();
    } else {
        // 配置无效 → 显示设置模态框
        this.showSettings();
    }
}
```

---

## 六、API 请求构建

### 6.1 GitHub API URL 生成

```javascript
getApiUrl(subPath = "") {
    const { username, repo, path } = this.configManager.config;
    let fullPath = path;
    if (subPath) fullPath = subPath;
    return `https://api.github.com/repos/${username}/${repo}/contents/${fullPath || ""}`;
}
```

**示例**:
```javascript
// 初始加载
config = { username: "ShingWha", repo: "my-notes", path: "notes" }
getApiUrl()  // → https://api.github.com/repos/ShingWha/my-notes/contents/notes

// 加载子目录
getApiUrl("notes/docs")  // → https://api.github.com/repos/ShingWha/my-notes/contents/notes/docs
```

---

## 七、错误处理

### 7.1 配置无效的情况

```javascript
// 情况 1: URL 中没有有效参数
URL: https://example.com/index.html
→ autoDetectFromUrl() 返回 false
→ 显示设置模态框

// 情况 2: URL 参数不完整
URL: https://example.com/index.html?user=ShingWha
→ 缺少 repo 参数
→ autoDetectFromUrl() 返回 false

// 情况 3: GitHub Pages URL 格式错误
URL: https://github.io/only-username
→ 无法提取 repo
→ autoDetectFromUrl() 返回 false
```

### 7.2 API 请求失败

```javascript
async fetchPath(path = "") {
    const url = this.configManager.getApiUrl(path);
    const res = await fetch(url);
    if (!res.ok) throw new Error("获取失败");  // 404, 403, 500 等
    // ...
}
```

**常见错误**:
- `404`: 仓库或路径不存在
- `403`: API 限流（未登录时每小时 60 次）
- `401`: 认证失败
- 网络错误

---

## 八、扩展建议

### 8.1 支持 GitHub 仓库链接

```javascript
// 在 autoDetectFromUrl() 中添加
else if (hostname === "github.com") {
    const parts = pathname.split("/").filter((p) => p);
    if (parts.length >= 2) {
        username = parts[0];
        repo = parts[1];
        path = "notes";  // 默认笔记路径
    }
}
```

### 8.2 支持私有仓库（需要 Token）

```javascript
// ConfigManager 添加 token 字段
saveConfig(config) {
    this.config = { ...config };
    localStorage.setItem("blog_config", JSON.stringify(this.config));
}

// DataManager 使用 Token
async fetchPath(path = "") {
    const url = this.configManager.getApiUrl(path);
    const headers = {};
    if (this.configManager.config.token) {
        headers["Authorization"] = `token ${this.configManager.config.token}`;
    }
    const res = await fetch(url, { headers });
    // ...
}
```

### 8.3 URL 哈希路由支持

```javascript
// 支持 #/username/repo/path 格式
autoDetectFromUrl() {
    const hash = window.location.hash.slice(1); // 去掉 #
    if (hash) {
        const parts = hash.split("/").filter((p) => p);
        if (parts.length >= 2) {
            username = parts[0];
            repo = parts[1];
            path = parts.slice(2).join("/");
        }
    }
    // ...
}
```

---

## 九、调试和测试

### 9.1 控制台输出

```javascript
// ConfigManager.autoDetectFromUrl() 中
console.log("自动检测配置:", { username, repo, path });

// UIManager.init() 中
console.log("当前配置:", { username, repo, path });
```

### 9.2 测试用例

| 测试 URL | 预期结果 | 说明 |
|---------|---------|------|
| `https://shingwha.github.io/my-notes/` | `{shingwha, my-notes, notes}` | 自动添加默认路径 |
| `https://github.io/user/repo/docs` | `{user, repo, docs}` | 标准格式 |
| `?user=A&repo=B&path=C` | `{A, B, C}` | URL 参数优先 |
| `https://example.com/` | 显示设置框 | 无法解析 |

---

## 十、总结

### 核心优势
1. **零配置启动**: 访问即用，自动检测
2. **多格式支持**: 兼容各种 GitHub Pages 部署方式
3. **参数覆盖**: URL 参数可手动覆盖自动检测
4. **智能默认**: 自动补充缺失的路径参数

### 数据流向
```
用户访问 URL
    ↓
autoDetectFromUrl() 解析
    ↓
ConfigManager 保存配置
    ↓
UIManager 初始化
    ↓
DataManager 获取数据
    ↓
渲染导航树和内容
```

### 关键代码位置
- **自动检测**: `ConfigManager.autoDetectFromUrl()` (L738-792)
- **配置管理**: `ConfigManager` 类 (L713-802)
- **初始化**: `UIManager.init()` (L847-861)
- **API 构建**: `ConfigManager.getApiUrl()` (L793-798)